(window.webpackJsonp_ember_auto_import_=window.webpackJsonp_ember_auto_import_||[]).push([[11],{58:function(e,t,n){"use strict"
n.r(t),n.d(t,"ClickstreamProcessor",(function(){return Ae}))
var r=n(62),i=n(64),o=n(65),s=function(){}
s.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},s.prototype.localStorageObject=r.j.localStorageObject,s.prototype.sessionStorageObject=r.j.sessionStorageObject
var a=function(){this.environment=new s,this.logger=Object(o.c)("mt-client-constraints")},c={nonEmpty:function(e,t){return!!r.h.isObject(t)&&t.hasOwnProperty(e)&&r.h.isDefinedNonNullNonEmpty(t[e])},valueMatches:function(e,t,n){if(!r.h.isObject(t))return!1
var i=t[e]
return t.hasOwnProperty(e)&&n.indexOf(i)>-1}},p="overrideFieldValue",u=function(){}
u.prototype.constrainedValue=function(e,t,n){var r=e&&e.hasOwnProperty(n)?e[n]:null
return this.applyConstraintRules(r,t)},u.prototype.applyConstraintRules=function(e,t){var n=e
return t&&t.blacklisted?n=null:t&&t.hasOwnProperty(p)&&(n=t.overrideFieldValue),n}
var l=r.k.exceptionString,h=function(e){this._constraintsInstance=e}
function d(e){var t,n=y(e=e||"").split("/")
return(t=-1===e.indexOf("//")?n[0]:n[2]).substring(t.indexOf("@")+1).split(":")[0]}function y(e){return(e=e||"").split("?")[0]}function f(e,t,n,i){var o=this.storageKey(i,n,t),s=this._constraintsInstance.system.environment,a=r.j.objectFromStorage(s.localStorageObject(),o)||{}
return a.value=this.idString(a,t),!this.rulesHaveLifespan(t)||r.h.isNumber(a.expirationTime)&&!this.timeExpired(a.expirationTime)||(a.expirationTime=this.expirationTime(t.lifespan)),r.j.saveObjectToStorage(s.localStorageObject(),o,a),a.value}h.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},h.prototype.constrainedValue=function(e,t,n,r){throw l("field_actions.Base","constrainedValue")},h.prototype.performAction=function(e,t,n){var i=t&&r.h.isDefined(t[e])?t[e]:null
return r.h.isDefinedNonNull(n)&&!r.h.isEmptyObject(n)&&(i=this.constrainedValue(i,n,t,e)),i}
var m={}
function v(e,t,n,r){var i=this.storageKey(r,n,t),o=m[i]
return o||(o=f.apply(this,arguments),m[i]=o),o}var g=function(){h.apply(this,arguments)};(g.prototype=Object.create(h.prototype)).constructor=g,g.prototype.SCOPE_STRATEGIES={ALL:"all",MAIN_DOMAIN:"mainDomain"},g.prototype.rulesHaveLifespan=function(e){return e=e||{},r.h.isNumber(e.lifespan)},g.prototype.expirationTime=function(e){return e?Date.now()+e:null},g.prototype.storageKey=function(e,t,n){var r=this.scope(t,n)
return this.storageKeyPrefix(n,e)+(r?"_"+r:"")},g.prototype.storageKeyPrefix=function(e,t){return e&&r.h.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtId_"+t},g.prototype.scope=function(e,t){var n,r,i,o,s=""
if(t&&(t.namespace&&(s+=t.namespace),t.scopeStrategy)){var a
switch(t.scopeStrategy){case this.SCOPE_STRATEGIES.MAIN_DOMAIN:r=(n=d(e[t.scopeFieldName]).split("."))[n.length-1],i=n[n.length-2],o=2,r&&2===r.length&&i&&(2===i.length||i in{com:!0,org:!0,net:!0,edu:!0,gov:!0})&&(o=3),a=n.slice(-1*o).join(".")||"unknownDomain"
break
case this.SCOPE_STRATEGIES.ALL:default:a=this.SCOPE_STRATEGIES.ALL}s.length&&(s+="_"),s+=a}return s},g.prototype.idString=function(e,t){var n=e?e.value:null,i=n
return(!n||r.h.isNumber(e.expirationTime)&&this.timeExpired(e.expirationTime))&&(i=this.generateId(t)),i},g.prototype.generateId=function(e){var t=this.rawUUID(),n=null,i=null
return e&&(n=this.expirationTime(e.lifespan),i=e.tokenSeparator),(this.generatedIdMetadata(n)+this.idTokenSeparator()+t||"").split(this.idTokenSeparator()).map((function(e){var t=parseInt(e,16)
return r.k.convertNumberToBaseAlphabet(t,r.k.base61Alphabet)})).join(this.generatedIdSeparator(i))||"0"},g.prototype.rawUUID=function(){return r.k.uuid()},g.prototype.generatedIdMetadata=function(e){var t=[this.generatedIdVersion()]
return e&&t.push(e),t.map((function(e){return e.toString(16)})).join(this.idTokenSeparator())},g.prototype.generatedIdVersion=function(){return 4},g.prototype.idTokenSeparator=function(){return"-"},g.prototype.generatedIdSeparator=function(e){return e||"z"},g.prototype.timeExpired=function(e){return e<=Date.now()},g.prototype.constrainedValue=function(e,t,n,i){return n&&t&&!r.h.isEmptyObject(t)&&(e=!0===t.persistIdForSession?v.apply(this,arguments):f.apply(this,arguments)),e}
var _=function(e,t){this._base=e,this._idAction=new g(t),this._idAction.setDelegate({storageKey:function(e,t,n){return this.storageKeyPrefix()+"_"+this.scope(t,n)}.bind(this._idAction),storageKeyPrefix:function(){return"mtClientId"}})}
_.prototype.constrainedValue=function(e,t){var n=t
t&&r.h.isNumber(t.expirationPeriod)&&((n=r.h.extend({},t)).lifespan=n.expirationPeriod,delete n.expirationPeriod)
var i=this._idAction.performAction("clientId",e,n)
return this._base.applyConstraintRules(i,t)}
var b=function(){h.apply(this,arguments)};(b.prototype=Object.create(h.prototype)).constructor=b,b.prototype.SCOPES={HOSTNAME:"hostname",FULL:"full",FULL_WITHOUT_PARAMS:"fullWithoutParams"},b.prototype.constrainedValue=function(e,t){if(e&&t&&t.scope)switch(t.scope){case this.SCOPES.HOSTNAME:e=d(e)
break
case this.SCOPES.FULL_WITHOUT_PARAMS:e=y(e)
break
case this.SCOPES.FULL:}return e}
var w=function(e){this._base=e,this._urlAction=new b}
w.prototype.constrainedValue=function(e,t){var n=this._urlAction.performAction("parentPageUrl",e,t)
return this._base.applyConstraintRules(n,t)}
var I=function(e){this.base=new u(e),this.clientId=new _(this.base,e),this.parentPageUrl=new w(this.base,e)},D=function(e){this._fieldHandlers=new I(e)}
function S(e,t,n,r){var i=e||{}
if(r=r||function(e,t,n){return e[n]||{}},t&&t[n]){var o,s,a=i[n]||{}
for(o in i[n]=a,t[n]){var c=r(a,t[n],o)
for(s in a[o]=c,t[n][o])c[s]=t[n][o][s]}}return i}D.prototype.applyConstraints=function(e,t){return t&&t.fieldConstraints&&(e=this.applyFieldConstraints(e,t.fieldConstraints)),e},D.prototype.applyFieldConstraints=function(e,t){if(t){var n,i,o,s={}
for(o in t)i=t[o],(e.hasOwnProperty(o)||!0===i.generateValue||i.hasOwnProperty(p))&&(n=o in this._fieldHandlers?this._fieldHandlers[o].constrainedValue(e,i):this._fieldHandlers.base.constrainedValue(e,i,o),s[o]=n)
for(o in s)e[o]=s[o]
e=r.e.mergeAndCleanEventFields(e)}return e}
var T=function(e){this.treatment=new D(e)}
T.prototype.constraintsForEvent=function(e,t,n){if(!t)return null
var r="constraints.profiles."+t.constraintProfile(n),i=t.value(r,n),o=null
if(i&&i.precedenceOrderedRules){var s=this
o=i.precedenceOrderedRules.reduce((function(t,n){return s.eventMatchesRule(e,n)&&(t=s.updateRules(t,n)),t}),{})}return o},T.prototype.eventMatchesRule=function(e,t){var n=!1
return e&&t.filters&&("any"===t.filters?n=!0:r.h.isObject(t.filters)&&(n=this.eventMatchesNonEmptyFields(e,t.filters.nonEmptyFields)&&this.eventMatchesFieldValues(e,t.filters.valueMatches))),n},T.prototype.eventMatchesNonEmptyFields=function(e,t){var n=!1
return e&&(n=!t||!r.h.isArray(t)||t.every((function(t){return c.nonEmpty(t,e)}))),n},T.prototype.eventMatchesFieldValues=function(e,t){var n=!1
return e&&(n=!(t&&r.h.isObject(t)&&!r.h.isEmptyObject(t))||Object.keys(t).every((function(n){var r=t[n]
return c.valueMatches(n,e,r)}))),n},T.prototype.updateRules=function(e,t){return S(e,t,"fieldConstraints")}
var A=function(){}
A.prototype.performAction=function(e,t){return!0!==t?e:null}
var O=function(){}
O.prototype.performAction=function(e,t){return e&&r.h.isArray(t)&&!r.h.isEmptyArray(t)?(e=r.h.extend({},e),t.forEach((function(t){delete e[t]})),r.h.isEmptyObject(e)?null:e):e}
var P=function(){}
P.prototype.performAction=function(e,t){if(!e||!r.h.isArray(t)||r.h.isEmptyArray(t))return e
var n={}
return Object.keys(e).forEach((function(r){t.indexOf(r)>-1&&(n[r]=e[r])})),r.h.isEmptyObject(n)?null:n}
var K=function(){this._actions={},this._actions.blacklisted=new A,this._actions.blacklistedFields=new O,this._actions.whitelistedFields=new P}
K.prototype.getAction=function(e){return this._actions[e]}
var N=function(){h.apply(this,arguments)};(N.prototype=Object.create(h.prototype)).constructor=N,N.prototype.constrainedValue=function(e,t){var n=t?t.precision:0
return r.h.isNumber(e)&&r.h.isNumber(n)&&n>0&&(e=Math.floor(e/n)*n),e}
var F=function(e){e=e||{},this._nextRotationTime=e.nextRotationTime||Number.POSITIVE_INFINITY,this._storageKey=e.namespace||"mt_serial_number",this._initialSerialNumber=e.initialSerialNumber||0,this._rotationPeriod=e.rotationPeriod||Number.POSITIVE_INFINITY}
F.prototype.setDelegate=function(e){r.h.attachDelegate(this,e)},F.prototype.localStorageObject=function(){return r.j.localStorageObject()},F.prototype.getNextSerialNumber=function(e){var t=this._storageKey,n=this._getCurrentSerialNumberData(t),i=n.sn
return e=r.h.isNumber(e)?e:1,i=parseInt(i,10),isNaN(i)&&(i=this._initialSerialNumber),i=this._increaseSerialNumber(i,e),n.sn=i,r.j.saveObjectToStorage(this.localStorageObject(),this._storageKey,n),i},F.prototype.resetSerialNumber=function(){var e=r.j.objectFromStorage(this.localStorageObject(),this._storageKey)
r.h.isDefinedNonNull(e)&&this._resetSerialNumber(e.exp)},F.prototype.getTime=function(){return Date.now()},F.prototype._increaseSerialNumber=function(e,t){return e+t},F.prototype._getCurrentSerialNumberData=function(e){var t,n,i=r.j.objectFromStorage(this.localStorageObject(),e)
for(i?(t=i.exp,t=parseInt(t,10),i.exp=t=isNaN(t)?this._nextRotationTime:t):t=this._nextRotationTime-this._rotationPeriod;!i||this.getTime()>=t;)t=n=t+this._rotationPeriod,i=this._resetSerialNumber(n)
return i},F.prototype._resetSerialNumber=function(e){var t={}
return t.exp=e,t.sn=this._initialSerialNumber,r.j.saveObjectToStorage(this.localStorageObject(),this._storageKey,t),t}
var x=function(){h.apply(this,arguments),this._storage=this._constraintsInstance.system.environment.localStorageObject(),this._precisionEndTimeCache={},this._serialNumberGenerator=null};(x.prototype=Object.create(h.prototype)).constructor=x,x.prototype.constrainedValue=function(e,t,n,i){var o=e
if(r.h.isNumber(e)&&r.h.isObject(t)&&r.h.isNumber(t.precision)&&t.precision>0){var s=this._computePrecisionStartTime(e,t)
this._serialNumberGenerator=new F({namespace:this._persistentStorageKey(t,i),nextRotationTime:s+t.precision,rotationPeriod:t.precision}),this._serialNumberGenerator.setDelegate(this._constraintsInstance.system.environment),this._serialNumberGenerator.setDelegate({getTime:function(){return e}})
var a=this._serialNumberGenerator.getNextSerialNumber()
o=this._computeTimestamp(s,a),this._serialNumberGenerator=null}return o},x.prototype._computeTimestamp=function(e,t){return e+t},x.prototype._persistentStorageKey=function(e,t){var n=e.namespace?"_"+e.namespace:""
return(e.storageKeyPrefix||"mtTimestamp")+n+"_"+t},x.prototype._computePrecisionStartTime=function(e,t){var n=t.precision
return Math.floor(e/n)*n}
var E=function(e){this.actions={},this.actions.idGenerator=new g(e),this.actions.numberDeres=new N(e),this.actions.timeDeres=new x(e),this.actions.urlDeres=new b(e)}
E.prototype.getAction=function(e){return this.actions[e]}
var M=function(e){this._eventActions=new K,this._fieldActions=new E(e)}
M.prototype.applyConstraints=function(e,t){var n=e
if(t&&!r.h.isEmptyObject(t)){if(t.fieldActions&&!r.h.isEmptyObject(t.fieldActions)){var i=this,o=Object.keys(t.fieldActions).reduce((function(e,r){var o=t.fieldActions[r]
if(o){var s=o.treatmentType,a=i._fieldActions.getAction(s)
if(o.blacklisted)e[r]=null
else if(o.hasOwnProperty(p))e[r]=o[p]
else if(a){var c=a.performAction(r,n,o)
e[r]=c}}return e}),{})
if(!r.h.isEmptyObject(o)){var s=r.h.extend({},n,o)
n=r.e.mergeAndCleanEventFields(s)}}t.eventActions&&!r.h.isEmptyObject(t.eventActions)&&Object.keys(t.eventActions).forEach((function(e){var r=this._eventActions.getAction(e)
if(r){var i=t.eventActions[e]
n=r.performAction(n,i)}}),this)}return n}
var k=function(e){this._constraintsInstance=e,this.treatment=new M(e)}
k.prototype._combineTreatments=function(e,t,n){var i=[]
return r.h.isArray(e)&&e.forEach((function(e){var r="treatmentProfiles."+e,o=t.value(r,n)
o&&o.treatments&&(i=i.concat(o.treatments))})),i},k.prototype.constraintsForEvent=function(e,t,n){if(!t)return null
var i=this,o=t.constraintProfiles(n)
if(!r.h.isDefinedNonNull(o)){var s=t.constraintProfile(n)
r.h.isDefinedNonNull(s)&&(o=[s])}if(!r.h.isDefinedNonNull(o))return null
if(!r.h.isArray(o))throw new TypeError('"constraintProfiles" should be an Array, but got: '+(o?o.constructor:o))
var a=this._combineTreatments(o,t,n)
if(0===a.length)throw new SyntaxError("The constraintProfiles: "+o.join(", ")+" are not found in the topic config")
return a.reduce((function(t,n){return i.eventMatchesTreatment(e,n)&&(t=function(e,t){var n=e||{}
return function(e,t){e.eventActions||(e.eventActions={})
var n=e.eventActions,i=t.eventActions
i&&Object.keys(i).reduce((function(e,t){var n=e[t],o=i[t]
return r.h.isArray(n)?r.h.isArray(o)&&o.forEach((function(e){-1===n.indexOf(e)&&n.push(e)})):r.h.isArray(o)?e[t]=o.slice():r.h.isObject(o)||r.h.isFunction(o)||(e[t]=o),e}),n)}(n,t),function(e,t){e.fieldActions||(e.fieldActions={}),S(e,t,"fieldActions",(function(e,t,n){return e[n]&&e[n].treatmentType===t[n].treatmentType?e[n]:{}}))}(n,t),n}(t,n)),t}),null)},k.prototype.eventMatchesTreatment=function(e,t){var n=t.filters
if(n&&r.h.isString(n))return"any"===n
if(!r.h.isDefinedNonNull(n)||0===n.length)throw new SyntaxError("Unable to find the filter in \n"+JSON.stringify(t))
return Object.keys(n).every((function(i){var o=n[i]
if(o&&r.h.isString(o))return!1
if(!o||!r.h.isObject(o)||r.h.isEmptyObject(o))throw new SyntaxError("Invalid filter object for field ("+i+") in \n"+JSON.stringify(t))
return Object.keys(o).every((function(n){var r=o[n]
if(c[n])return c[n](i,e,r)
throw new SyntaxError("Unable to find the filter ("+n+") for field ("+i+")in \n"+JSON.stringify(t))}))}))}
var C={constraintProfile:function(e){return this.value("constraints.defaultProfile",e)},constraintProfiles:function(e){return this.value("defaultTreatmentProfiles",e)}},V=function(e,t){if(n=e,i=!0,(i&=r.h.isDefinedNonNull(n))&&(i&=!r.h.isEmptyObject(n),i&=r.h.isFunction(n.initialized),i&=r.h.isFunction(n.value),i&=r.h.isFunction(n.constraintProfile)),!i)throw new Error('The topic config is not a valid instance of "mt-client-config".')
var n,i
this._isInitialized=!1,this._topicConfig=e,this._constraintGenerator=null,this.system=new a,r.h.setDelegates(this.system,t||{})}
V.prototype._getConstraintGenerator=function(){var e=this._topicConfig
return this._constraintGenerator&&this._isInitialized||(this._isInitialized=e.initialized(),function(e){return r.h.isDefinedNonNull(e.value("treatmentProfiles"))}(e)?this._constraintGenerator=new k(this):this._constraintGenerator=new T(this)),this._constraintGenerator},V.prototype.constraintsForEvent=function(e,t){return this._getConstraintGenerator().constraintsForEvent(e,this._topicConfig,t)},V.prototype.applyConstraintTreatments=function(e,t){if(void 0===t)try{t=this.constraintsForEvent(e)}catch(e){return this.system.logger.warn("An error occupied while applying constraints: "+e.message||!1),null}return this._getConstraintGenerator().treatment.applyConstraints(e,t)}
var H=V
function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var R="7.3.1",B={mtName:function(){return"mt-metricskit"},mtVersion:function(){return R}},U={attachDelegateInfo:function(e){r.h.extend(e,B)}},W={treatmentProfiles:{AMPWeb:{treatments:[{filters:"any",fieldActions:{clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",namespace:"AMPWeb_isSignedOut",lifespan:864e5}}},{filters:{isSignedIn:{valueMatches:[!0]}},fieldActions:{clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",namespace:"AMPWeb_isSignedIn",lifespan:15552e6}}}]},AMPFunnel:{treatments:[{filters:"any",eventActions:{blacklistedFields:["mtClientId","mtRequestId","pliIds","userAgent","screenHeight","screenWidth","windowInnerHeight","windowInnerWidth","windowOuterHeight","windowOuterWidth"]},fieldActions:{eventTime:{treatmentType:"timeDeres",precision:864e5},clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtId_clientId_unidentified",lifespan:15552e6}}}]},strict:{treatments:[{filters:"any",fieldActions:{consumerId:{blacklisted:!0},dsId:{blacklisted:!0},clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",scopeFieldName:"parentPageUrl",scopeStrategy:"mainDomain",lifespan:864e5},parentPageUrl:{treatmentType:"urlDeres",scope:"hostname"}}},{filters:{eventType:{valueMatches:["click"]},actionType:{valueMatches:["signUp"]}},fieldActions:{parentPageUrl:{treatmentType:"urlDeres",scope:"fullWithoutParams"}}},{filters:{eventType:{valueMatches:["dialog"]},dialogType:{valueMatches:["upsell"]},result:{valueMatches:["upsell"]}},fieldActions:{parentPageUrl:{treatmentType:"urlDeres",scope:"fullWithoutParams"}}},{filters:{userType:{valueMatches:["signedIn"]}},fieldActions:{clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",scopeStrategy:"all"}}},{filters:{userType:{valueMatches:["signedIn"]},eventType:{valueMatches:["click","dialog","media","search"]}},fieldActions:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}},{filters:{userType:{valueMatches:["signedIn"]},eventType:{valueMatches:["page","impressions"]},pageHistory:{nonEmpty:!0}},fieldActions:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}}]}}},G={xp_its_music_main:{treatmentProfiles:{AMPWeb:{treatments:[{filters:"any",fieldActions:{clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",namespace:"AMPWeb_isSignedOut",lifespan:864e5,persistIdForSession:!0},analyticsClientId:{treatmentType:"idGenerator",namespace:"AMPWeb_isSignedOut",lifespan:864e5,persistIdForSession:!0}}},{filters:{isSignedIn:{valueMatches:[!0]}},fieldActions:{clientId:{treatmentType:"idGenerator",storageKeyPrefix:"mtClientId",namespace:"AMPWeb_isSignedIn",lifespan:15552e6,persistIdForSession:!0},analyticsClientId:{treatmentType:"idGenerator",namespace:"AMPWeb_isSignedIn",lifespan:15552e6,persistIdForSession:!0}}}]}}},xp_amp_tv_main:{treatmentProfiles:{AMPWeb:{treatments:[{filters:"any",fieldActions:{clientId:{blacklisted:!0}}},{filters:{isSignedIn:{valueMatches:[!1]}},fieldActions:{clientId:{treatmentType:"idGenerator",namespace:"AMPWeb_isSignedOut",lifespan:864e5}}}]}}},xp_amp_tv_unidentified:r.h.extend({},W,{blacklistedFields:["consumerId"]}),default_constraints:W}
r.h.attachMethods(i.a,r.b,i.a)
function L(e,t){var n=(t=t||{}).delegates||{},o=t.configSourcesFn,s=t.onSuccessHandler,a=t.onFailureHandler,c=n.environment,p=n.network,u=n.logger
r.h.isFunction(o)||function(e){if(!e.cachedSource()){var t=function(e){var t=G[e]
return r.h.isDefinedNonNull(t)||(t=W),t}(e.topic())
e.setCachedSource(t)}}(e),i.a.environment.setDelegate(c),i.a.logger.setDelegate(u),i.a.network.setDelegate(p),function(e){var t
r.h.attachMethods(e,r.b,e),t=e,r.h.isFunction(t.constraintProfile)&&r.h.isFunction(t.constraintProfiles)||r.h.attachMethods(t,C,t),U.attachDelegateInfo(e)}(e),e.init(o,s,a)}var z={CLIENT_EVENT_ID:"clientEventId",CONSUMER_ID:"consumerId",CONSUMER_NS:"consumerNs",DELEGATE_APP:"delegateApp",EVENT_VERSION:"eventVersion",STOREFRONT_COUNTRY_CODE:"storeFrontCountryCode"},J=r.k.exceptionString,q=["app","appVersion","capacityData","capacityDataAvailable","capacityDisk","capacitySystem","capacitySystemAvailable","connectionType","dsId","hostApp","osVersion","pageUrl","pixelRatio","resourceRevNum","screenHeight","screenWidth","storeFrontHeader","userAgent","userType","windowInnerHeight","windowInnerWidth","windowOuterHeight","windowOuterWidth"],Y=["consumerId","consumerNs","cookie","delegateApp","environmentInstance","hardwareBrand","hardwareFamily","hardwareModel","hostAppVersion","os","osBuildNumber","osLanguages","parentPageUrl","storeFrontCountryCode"],Q=!1,X=function(){},Z=function e(){Q||(Q=!0,q.forEach((function(t){e.prototype[t]=function(){throw J("metrics.system.environment",t)}})),Y.forEach((function(t){e.prototype[t]=X})))}
Z.prototype.setDelegate=function(e){return r.c.setDelegate(e),r.h.attachDelegate(this,e)},Z.prototype.localStorageObject=r.j.localStorageObject,Z.prototype.sessionStorageObject=r.j.sessionStorageObject
var $=function(){}
$.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},$.prototype.recordEvent=function(e,t){throw r.k.exceptionString("metrics.system.event_recorder","recordEvent")},$.prototype.sendMethod=function(){throw r.k.exceptionString("metrics.system.event_recorder","sendMethod")},$.prototype.flushUnreportedEvents=function(e){}
var ee=Object(o.c)("mt-metricskit"),te=function(){for(var e in this.environment=new Z,this.eventRecorder=new $,this.logger=ee,this)U.attachDelegateInfo(this[e])},ne=function(e){this._metricsKit=e}
ne.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ne.prototype.metricsData=function(e,t,n){return this._metricsKit.eventHandlers.base.processMetricsData.apply(this,arguments)},ne.prototype.knownFields=function(){return["eventType","eventVersion","type"]},ne.prototype.eventType=function(e){return"account"},ne.prototype.eventVersion=function(e){return e&&e.eventVersion||1}
var re=z,ie=function(e){this._metricsKit=e}
ie.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ie.prototype.metricsData=function(e,t,n){var r=Array.prototype.slice.call(arguments),i=this._metricsKit.config.value("metricsBase")
return i&&r.push(i),this.processMetricsData.apply(this,r)},ie.prototype.processMetricsData=function(e,t,n){var r=null,i="function"==typeof this.eventType?this.eventType():null,o=this._metricsKit.config,s=this._metricsKit.eventHandlers.base,a=this._metricsKit.utils,c=this._metricsKit._constraints
if(!o.metricsDisabledOrBlacklistedEvent(i)){var p=this!==s,u="function"!=typeof this.mtIncludeBaseFields||this.mtIncludeBaseFields(),l=Array.prototype.slice.call(arguments,3)
if(p&&u){var h=s.metricsData.apply(s,arguments)
l=[h].concat(l)}r=a.eventFields.processMetricsData(this,this.knownFields(),e,t,n,l),p&&(r=c.applyConstraintTreatments(r),o.removeBlacklistedFields(r),o.applyDeRes(r))}return r},ie.prototype.knownFields=function(){return["app","appVersion","baseVersion","capacityData","capacityDataAvailable","capacityDisk","capacitySystem","capacitySystemAvailable","connection","constraintProfile","constraintProfiles",re.CONSUMER_ID,re.CONSUMER_NS,re.CLIENT_EVENT_ID,"clientId",re.DELEGATE_APP,"dsId","environmentInstance","eventTime","isSignedIn","hardwareBrand","hardwareFamily","hardwareModel","hostApp","hostAppVersion","os","osBuildNumber","osVersion","page","pageContext","pageDetails","pageId","pageType","pageUrl","parentPageUrl","pixelRatio","resourceRevNum","screenHeight","screenWidth",re.STOREFRONT_COUNTRY_CODE,"storeFrontHeader","timezoneOffset","userAgent","userType","windowInnerHeight","windowInnerWidth","windowOuterHeight","windowOuterWidth","xpPostFrequency","xpSendMethod","xpVersionMetricsKit","xpDelegatesInfo"]},ie.prototype.app=function(e){var t=this._metricsKit.system.environment
return e&&e.app||t.app()},ie.prototype.appVersion=function(e){var t=this._metricsKit.system.environment
return e&&e.appVersion||t.appVersion()},ie.prototype.baseVersion=function(e){return 1},ie.prototype.capacityData=function(e){var t=this._metricsKit.system.environment
return e&&e.capacityData||t.capacityData()},ie.prototype.capacityDataAvailable=function(e){var t=this._metricsKit.system.environment
return e&&e.capacityDataAvailable||t.capacityDataAvailable()},ie.prototype.capacityDisk=function(e){var t=this._metricsKit.system.environment
return e&&e.capacityDisk||t.capacityDisk()},ie.prototype.capacitySystem=function(e){var t=this._metricsKit.system.environment
return e&&e.capacitySystem||t.capacitySystem()},ie.prototype.capacitySystemAvailable=function(e){var t=this._metricsKit.system.environment
return e&&e.capacitySystemAvailable||t.capacitySystemAvailable()},ie.prototype.connection=function(e){var t=this._metricsKit.system.environment
return e&&e.connection||t.connectionType()},ie.prototype.constraintProfile=function(e){var t=this._metricsKit.config
return e&&e.constraintProfile||t.constraintProfile()},ie.prototype.constraintProfiles=function(e){var t=this._metricsKit.config
return e&&e.constraintProfiles||t.constraintProfiles()},ie.prototype.consumerId=function(e){var t=this._metricsKit.system.environment
return e&&e[re.CONSUMER_ID]||t.consumerId()},ie.prototype.consumerNs=function(e){var t=this._metricsKit.system.environment
return e&&e[re.CONSUMER_NS]||t.consumerNs()},ie.prototype.clientEventId=function(e){var t=e&&e[re.CLIENT_EVENT_ID]
return t||(r.k.cryptoRandomBase62String&&(t=r.k.cryptoRandomBase62String(!0)),t||(t=r.k.uuid())),t},ie.prototype.clientId=function(e){var t,n=this._metricsKit.config
return e&&e.clientId?t=e.clientId:n.value("ignoreClientIdCookie")||(t=r.c.get("xp_ci")),t},ie.prototype.delegateApp=function(e){var t=this._metricsKit.system.environment
return e&&e[re.DELEGATE_APP]||t.delegateApp()},ie.prototype.dsId=function(e){var t=this._metricsKit.system.environment
return e&&e.dsId||t.dsId()},ie.prototype.isSignedIn=function(e){return e&&"isSignedIn"in e?e.isSignedIn:!!this.dsId(e)},ie.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},ie.prototype.hardwareBrand=function(e){var t=this._metricsKit.system.environment
return e&&e.hardwareBrand||t.hardwareBrand()},ie.prototype.hardwareFamily=function(e){var t=this._metricsKit.system.environment
return e&&e.hardwareFamily||t.hardwareFamily()},ie.prototype.hardwareModel=function(e){var t=this._metricsKit.system.environment
return e&&e.hardwareModel||t.hardwareModel()},ie.prototype.hostApp=function(e){var t=this._metricsKit.system.environment
return e&&e.hostApp||t.hostApp()},ie.prototype.hostAppVersion=function(e){var t=this._metricsKit.system.environment
return e&&e.hostAppVersion||t.hostAppVersion()},ie.prototype.os=function(e){var t=this._metricsKit.system.environment
return e&&e.os||t.os()},ie.prototype.osBuildNumber=function(e){var t=this._metricsKit.system.environment
return e&&e.osBuildNumber||t.osBuildNumber()},ie.prototype.osVersion=function(e){var t=this._metricsKit.system.environment
return e&&e.osVersion||t.osVersion()},ie.prototype.page=function(e){if(!e)throw"No data provided to event_handlers/base page function"
if(e.page)return e.page
if(this.pageType(e)&&this.pageId(e)){var t=this._metricsKit.config
return this.pageType(e)+t.value("compoundSeparator")+this.pageId(e)}},ie.prototype.pageContext=function(e){return e&&e.pageContext},ie.prototype.pageDetails=function(e){return e&&e.pageDetails},ie.prototype.pageId=function(e){return e&&e.pageId},ie.prototype.pageType=function(e){return e&&e.pageType},ie.prototype.pageUrl=function(e){var t=this._metricsKit.system.environment
return e&&e.pageUrl||t.pageUrl()},ie.prototype.parentPageUrl=function(e){var t=this._metricsKit.system.environment
return e&&e.parentPageUrl||t.parentPageUrl()},ie.prototype.pixelRatio=function(e){var t=this._metricsKit.system.environment
return e&&e.pixelRatio||t.pixelRatio()},ie.prototype.resourceRevNum=function(e){var t=this._metricsKit.system.environment
return e&&e.resourceRevNum||t.resourceRevNum()},ie.prototype.screenHeight=function(e){var t=this._metricsKit.system.environment
return e&&e.screenHeight||t.screenHeight()},ie.prototype.screenWidth=function(e){var t=this._metricsKit.system.environment
return e&&e.screenWidth||t.screenWidth()},ie.prototype.storeFrontCountryCode=function(e){var t=this._metricsKit.system.environment
return e&&e[re.STOREFRONT_COUNTRY_CODE]||t.storeFrontCountryCode()},ie.prototype.storeFrontHeader=function(e){var t=this._metricsKit.system.environment
return e&&e.storeFrontHeader||t.storeFrontHeader()},ie.prototype.timezoneOffset=function(e){return e&&e.timezoneOffset||(new Date).getTimezoneOffset()},ie.prototype.userAgent=function(e){var t=this._metricsKit.system.environment
return e&&e.userAgent||t.userAgent()},ie.prototype.userType=function(e){var t=this._metricsKit.system.environment
return e&&e.userType||t.userType()},ie.prototype.windowInnerHeight=function(e){var t=this._metricsKit.system.environment
return e&&e.windowInnerHeight||t.windowInnerHeight()},ie.prototype.windowInnerWidth=function(e){var t=this._metricsKit.system.environment
return e&&e.windowInnerWidth||t.windowInnerWidth()},ie.prototype.windowOuterHeight=function(e){var t=this._metricsKit.system.environment
return e&&e.windowOuterHeight||t.windowOuterHeight()},ie.prototype.windowOuterWidth=function(e){var t=this._metricsKit.system.environment
return e&&e.windowOuterWidth||t.windowOuterWidth()},ie.prototype.xpPostFrequency=function(e){var t=this._metricsKit.config
return e&&e.xpPostFrequency||t.value("postFrequency")},ie.prototype.xpViewablePercentage=function(e){var t=this._metricsKit.config
return e&&e.xpViewablePercentage||t.value("impressions.viewablePercentage")},ie.prototype.xpSendMethod=function(e){var t=this._metricsKit.system
return e&&e.xpSendMethod||t.eventRecorder.sendMethod()},ie.prototype.xpVersionMetricsKit=function(){return R},ie.prototype.xpDelegatesInfo=function(){var e=r.d.getStoredDelegateObject(this)
return e&&e.delegates||void 0}
var oe=function(e){this._metricsKit=e}
oe.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},oe.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},oe.prototype.knownFields=function(){return["eventType","eventVersion"]},oe.prototype.eventType=function(e){return"buyConfirmed"},oe.prototype.eventVersion=function(e){return e&&e.eventVersion||1},oe.prototype.createClientBuyId=function(){var e=null,t=this._metricsKit.system.environment,n=t.sessionStorageObject().getItem("mtMetricsKit_previousClientBuyId")
return e=++n,n||(this._metricsKit.system.logger.warn("Metrics: buyConfirmed.createClientBuyId: clientBuyId did not exist or was of incorrect type, reset to 1."),e=1),t.sessionStorageObject().setItem("mtMetricsKit_previousClientBuyId",e),e},oe.prototype.clientBuyIdQueryParamString=function(e){return"&clientBuyId="+e},oe.prototype.metricsBuyParamsString=function(e,t,n,i){var o,s,a=this._metricsKit.eventHandlers.base,c=this._metricsKit.eventHandlers.page,p=Array.prototype.slice.call(arguments,4),u=c.pageHistory(),l=a.clientId()
return Array.isArray(u)?u.length>=2&&(o=u[u.length-2]):this._metricsKit.system.logger.warn("MetricsKit: metricsBuyParamsString: pageHistory is not an Array"),s={mtApp:a.app(),mtEventTime:Date.now(),mtHardwareBrand:a.hardwareBrand(),mtHardwareFamily:a.hardwareFamily(),mtHardwareModel:a.hardwareModel(),mtHostApp:a.hostApp(),mtHostAppVersion:a.hostAppVersion(),mtOs:a.os(),mtOsBuildNumber:a.osBuildNumber(),mtOsVersion:a.osVersion(),mtPageId:e,mtPageType:t,mtPageContext:n,mtTopic:i||"xp_its_main",mtPrevPage:o,mtRequestId:r.k.uuid(),mtClientId:l},r.h.extend.apply(r.h,[s].concat(p)),r.k.paramString(s)},oe.prototype.cacheMetricsBuyData=function(e,t){var n=this._metricsKit.system.environment
if(2!=arguments.length)this._metricsKit.system.logger.error("buyConfirmed.cacheMetricsBuyData(): function invoked with incorrect number of parameters. Perhaps you meant to retrieve cached data instead of setting it, which would be a call to uncacheMetricsBuyData(clientBuyId)?")
else{var r=JSON.stringify(t)
n.sessionStorageObject().setItem("mtMetricsKit_metricsBuyData_for_clientBuyId_"+e,r)}},oe.prototype.uncacheMetricsBuyData=function(e){var t=null,n=this._metricsKit.system.environment
if(1!=arguments.length)this._metricsKit.system.logger.error("buyConfirmed.uncacheMetricsBuyData(): function invoked with incorrect number of parameters. Perhaps you meant to set cached data instead of retrieving it, which would be a call to cacheMetricsBuyData(clientBuyId, metricsBuyData)?")
else{var r=n.sessionStorageObject().getItem("mtMetricsKit_metricsBuyData_for_clientBuyId_"+e)
r&&(t=JSON.parse(r),n.sessionStorageObject().removeItem("mtMetricsKit_metricsBuyData_for_clientBuyId_"+e))}return t},oe.prototype.buyFailureOccurred=function(e){var t=this.uncacheMetricsBuyData(e)
t&&(t.detoured=!0,this.cacheMetricsBuyData(e,t))}
var se=function(e){var t=null
try{t=JSON.parse(e)}catch(e){ee.error("MetricsKit: error parsing click data - "+e)}return t},ae=function(e){this._metricsKit=e}
ae.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ae.prototype.metricsData=function(e,t,n,r){var i=[e,t,n],o=this._metricsKit.eventHandlers.base,s=this._metricsKit.utils
return r&&(i.push({location:s.eventFields.buildLocationStructure(r,this.locationDataForElement)}),i.push(this.dataForElement(r)||{})),i=i.concat(Array.prototype.slice.call(arguments,4)),o.processMetricsData.apply(this,i)},ae.prototype.knownFields=function(){return["actionContext","actionDetails","actionType","actionUrl","eventType","eventVersion","impressions","location","targetId","targetType","positionX","positionY","xpViewablePercentage"]},ae.prototype.dataForElement=function(e){var t=null
if(e&&r.h.isFunction(e.hasAttribute)&&r.h.isFunction(e.getAttribute)){var n=this.dataAttribute()
e.hasAttribute(n)&&(t=se(e.getAttribute(n)))}return t},ae.prototype.dataAttribute=function(){return"data-metrics-click"},ae.prototype.locationDataForElement=function(e){var t,n,r,i=e.parentNode,o=0,s=null
if(e.hasAttribute&&e.hasAttribute("data-metrics-location")&&(s=se(e.getAttribute("data-metrics-location"))).locationType){if(i){t=i.childNodes
for(var a=0;a<t.length;a++)if((r=(n="function"==typeof t.item&&t.item(a)||t[a]).hasAttribute&&n.hasAttribute("data-metrics-location")?se(n.getAttribute("data-metrics-location")):void 0)?r.locationType:void 0){if(n===e)break
o++}}s.locationPosition=o}return s},ae.prototype.eventType=function(e){return"click"},ae.prototype.eventVersion=function(e){return e&&e.eventVersion||4},ae.prototype.impressions=function(e){return e?e.impressions:void 0},ae.prototype.xpViewablePercentage=function(e){return this._metricsKit.eventHandlers.base.xpViewablePercentage(e)}
var ce=function(e){this._metricsKit=e}
ce.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ce.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},ce.prototype.knownFields=function(){return["buttons","code","details","message","type","eventType","eventVersion","type"]},ce.prototype.eventType=function(e){return"dialog"},ce.prototype.eventVersion=function(e){return e&&e.eventVersion||2}
var pe=function(e){this._metricsKit=e}
pe.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},pe.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},pe.prototype.knownFields=function(){return["eventType","eventVersion","extRefUrl","osLanguages","refApp","type"]},pe.prototype.eventType=function(e){return"enter"},pe.prototype.eventVersion=function(e){return e&&e.eventVersion||1},pe.prototype.osLanguages=function(e){return e&&e.osLanguages||this._metricsKit.system.environment.osLanguages()}
var ue=function(e){this._metricsKit=e}
ue.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ue.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},ue.prototype.knownFields=function(){return["destinationUrl","eventType","eventVersion","type"]},ue.prototype.eventType=function(e){return"exit"},ue.prototype.eventVersion=function(e){return e&&e.eventVersion||1}
var le=function(e){this._metricsKit=e}
le.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},le.prototype.metricsData=function(e){var t=[void 0,void 0,void 0],n=this._metricsKit.eventHandlers.base
t.push({eventType:e})
var r=Array.prototype.slice.call(arguments,1)
return t=t.concat(r),n.processMetricsData.apply(this,t)},le.prototype.knownFields=function(){return["eventTime","eventType"]},le.prototype.mtIncludeBaseFields=function(){return!1},le.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},le.prototype.eventType=function(e){return e&&e.eventType||void 0}
var he=function(e){this._metricsKit=e}
he.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},he.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},he.prototype.knownFields=function(){return["eventType","eventVersion","impressions","xpViewablePercentage","xpViewableThreshold"]},he.prototype.eventType=function(e){return"impressions"},he.prototype.eventVersion=function(e){return e&&e.eventVersion||3},he.prototype.impressions=function(e){return e?e.impressions:void 0},he.prototype.xpViewablePercentage=function(e){return this._metricsKit.eventHandlers.base.xpViewablePercentage(e)},he.prototype.xpViewableThreshold=function(e){var t=this._metricsKit.config
return e&&e.xpViewableThreshold||t.value("impressions.viewableThreshold")}
var de=z,ye=function(e){this._metricsKit=e}
ye.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ye.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},ye.prototype.knownFields=function(){return["eventType",de.EVENT_VERSION,"id","idType","type","typeDetails","actionType","actionDetails","url","duration","position"]},ye.prototype.eventType=function(e){return"media"},ye.prototype.eventVersion=function(e){return e&&e.eventVersion||1}
var fe=function(e){this._metricsKit=e,this.pageHistoryCache=[]}
fe.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},fe.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},fe.prototype.knownFields=function(){return["eventType","eventVersion","extRefUrl","hostApp","refApp","refUrl","requestStartTime","responseStartTime","responseEndTime","pageHistory","pageLoadTime","pageRenderTime","searchFilters","searchTerm"]},fe.prototype.eventType=function(e){return"page"},fe.prototype.eventVersion=function(e){return e&&e.eventVersion||1},fe.prototype.pageHistory=function(e){var t
if((e=e||{}).pageHistory)t=e.pageHistory
else{t=this.pageHistoryCache.slice(0)
var n=e.page
n&&(this.pageHistoryCache.length>=5&&this.pageHistoryCache.shift(),this.pageHistoryCache.push(n))}return t}
var me=function(e){this._metricsKit=e}
me.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},me.prototype.metricsData=function(e,t,n){var r=this._metricsKit.eventHandlers.base
return r.processMetricsData.apply(this,arguments)},me.prototype.knownFields=function(){return["actionDetails","actionType","actionUrl","eventType","eventVersion","filters","location","targetId","targetType","term"]},me.prototype.eventType=function(e){return"search"},me.prototype.eventVersion=function(e){return e&&e.eventVersion||2}
var ve=function(e){this._metricsKit=e}
ve.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},ve.prototype.metricsData=function(e){var t=[null,null,null].concat(Array.prototype.slice.call(arguments))
return this._metricsKit.eventHandlers.base.processMetricsData.apply(this,t)},ve.prototype.knownFields=function(){return["eventType","eventVersion"]},ve.prototype.eventType=function(e){return"transaction"},ve.prototype.eventVersion=function(e){return e&&e.eventVersion||1}
var ge=function(e){this.account=new ne(e),this.base=new ie(e),this.buyConfirmed=new oe(e),this.click=new ae(e),this.dialog=new ce(e),this.enter=new pe(e),this.exit=new ue(e),this.flexible=new le(e),this.impressions=new he(e),this.media=new ye(e),this.page=new fe(e),this.search=new me(e),this.transaction=new ve(e),U.attachDelegateInfo(this.account),U.attachDelegateInfo(this.base),U.attachDelegateInfo(this.buyConfirmed),U.attachDelegateInfo(this.click),U.attachDelegateInfo(this.enter),U.attachDelegateInfo(this.exit),U.attachDelegateInfo(this.flexible),U.attachDelegateInfo(this.impressions),U.attachDelegateInfo(this.media),U.attachDelegateInfo(this.page),U.attachDelegateInfo(this.search),U.attachDelegateInfo(this.transaction)},_e=function(e){this._metricsKit=e}
_e.prototype.getIdType=function(e){var t=this._metricsKit.config,n=e.indexOf("."),r=t.value("compoundSeparator")
return(-1!==n?e.substring(0,n):"its")+r+"id"},_e.prototype.processMetricsData=function(e,t,n,i,o,s){var a=[{pageId:n,pageType:i,pageContext:o}]
return r.h.isArray(s)&&(a=a.concat(s)),r.e.processMetricsData(e,t,!0,a)},_e.prototype.applyFieldsMap=function(e,t){var n,i,o,s,a=this._metricsKit.config
if(e&&t)if(o={},n=a.value("fieldsMap")||{},i=r.f.valueForKeyPath(t,n,n.custom))if(Array.isArray(i))for(s=0;s<i.length;++s)e[i[s]]&&(o[i[s]]=e[i[s]])
else if("object"===j(i))for(var c in i)for(s=0;s<i[c].length;++s){var p=r.f.valueForKeyPath(i[c][s],e)
if(p){o[c]=p
break}}else this._metricsKit.system.logger.error("mt-metricskit: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)")
else this._metricsKit.system.logger.error("mt-metricskit: unable to get fieldsMap from config-source")
else e||this._metricsKit.system.logger.error("mt-metricskit: No data provided to applyFieldsMap"),t||this._metricsKit.system.logger.error("mt-metricskit: No sectionName provided to applyFieldsMap")
return o},_e.prototype.flattenImpressions=function(e,t){var n,i,o,s,a=[],c=t||1
if(e){e=function(e){var t,n={},r=[]
if(e&&e[0]&&void 0!==e[0].index)for(var i=0;i<e.length;++i)n[t=e[i].index]||(n[t]=!0,r.push(e[i]))
return r}(e)
for(var p=0;p<e.length;p++){if("string"==typeof(n=e[p]).data)try{i=JSON.parse(n.data)}catch(e){s=decodeURIComponent(n.data)
try{i=JSON.parse(s)}catch(t){this._metricsKit.system.logger.error("mt-metricskit: non-JSON serialized data found on impression object. Cannot parse.",e)}}else i=n
if(i){if(i.impressionTimes=n.timestamps,i.impressionIndex=n.index,i.id&&!i.idType)if("genre"===n.kind){var u=this._metricsKit.config
i.idType="label"+u.value("compoundSeparator")+"id"}else i.idType=this.getIdType(i.id.toString())
n.parent&&void 0!==n.parent.impressionId&&(i.impressionParentId=n.parent.impressionId),i.impressionId=c,n.impressionId=c,++c,a.push(i),r.f.valueForKeyPath("children.length",n)>0&&(o=this.flattenImpressions(n.children,c),a=a.concat(o),c+=o.length)}}}else this._metricsKit.system.logger.warn("Fuse-Metrics: No impressions provided to to flattenImpressions")
return a},_e.prototype.buildLocationStructure=function(e,t){for(var n,r=e,i=[];r;)(n=t.call(t,r))&&i.push(n),r=r.parentNode
return i}
var be=function(){}
be.prototype.setDelegate=function(e){return r.h.attachDelegate(this,e)},be.prototype.makeAjaxRequest=r.g.makeAjaxRequest
var we={attachDelegate:function(e,t){return r.h.attachDelegate(e,t)},extend:function(e){return r.h.extend.apply(r.h,arguments)},bindFunctionsContext:function(e){if(e)for(var t in e)"function"==typeof e[t]&&(e[t]=e[t].bind(e))}},Ie={versionStringFromUserAgent:function(e,t){return r.k.versionStringFromUserAgent(e,t)}},De=function(e){this.delegateExtension=U,this.eventFields=new _e(e),we.bindFunctionsContext(this.eventFields),this.keyValue=r.f,this.network=new be,this.reflect=we,this.string=Ie},Se=function(e){this._metricsKit=e,this._baseEventHandler=Object.create(this._metricsKit.eventHandlers.base)}
Se.prototype.clientId=function(e){if(!this._metricsKit.config.initialized())return this._metricsKit.system.logger.error("Unable to load topic config, please invoke clientId() after MetricsKit is initialized."),null
var t=this._baseEventHandler.metricsData(null,null,null,e)
return t?t.clientId:null}
var Te=function(e){this.base=new Se(e)},Ae=function(e,t){this._initCalled=!1,this._delegatePackage=t,this.system=new te,this.config=i.a.getConfig(e),this.eventHandlers=new ge(this),this.eventFields=new Te(this),this.utils=new De(this),this._constraints=null,r.h.isDefined(e)||this.system.logger.error("No topic is provided to ClickstreamProcessor."),r.h.isDefinedNonNull(t)||this.system.logger.error("No delegate is provided to ClickstreamProcessor")}
Ae.prototype.init=function(e){this._initCalled||(this._initCalled=!0,e=function(e,t){t=t||{}
var n={onSuccessHandler:null,onFailureHandler:null,configSourcesFn:null}
return n.configSourcesFn=t.configSourcesFn,n.onSuccessHandler=t.onSuccessHandler,n.onFailureHandler=t.onFailureHandler,n}(0,e),L(this.config,{configSourcesFn:e.configSourcesFn,onSuccessHandler:e.onSuccessHandler,onFailureHandler:e.onFailureHandler,delegates:{environment:this.system.environment,logger:this.system.logger,network:this.utils.network}}),this._constraints=new H(this.config,{environment:this.system.environment}),this._delegatePackage&&(r.h.setDelegates(this.eventHandlers,this._delegatePackage),r.h.setDelegates(this.system,this._delegatePackage),r.h.setDelegates(this.utils,this._delegatePackage)))},Ae.prototype.cleanup=function(){var e
this._delegatePackage&&r.h.isFunction(this._delegatePackage.cleanup)&&this._delegatePackage.cleanup(),e=this.config,i.a.cleanupConfig(e.topic()),r.h.detachMethods(i.a.environment),r.h.detachMethods(i.a.logger),r.h.detachMethods(i.a.network),r.h.resetDelegates(this.eventHandlers),r.h.resetDelegates(this.system),r.h.resetDelegates(this.utils),this.config=null,this.system=null,this.eventHandlers=null,this.utils=null,this._delegatePackage=null,this._constraints=null,this._initCalled=!1}}}])
